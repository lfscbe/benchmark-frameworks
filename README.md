# About

O projeto tem uma coletânia de docker composes com o propósito de subir containers em respectivos profiles para benchmark com testes de carga.

Cada framework possui sua própria pasta em `/builds` onde poderá ter:
- Um único `compose.yaml` que conterá serviços com diferentes profiles que subuirão diferentes containers em diferentes cenários.
- Um arquivo de configuração autogerado para o nginx `nginx-autogenerated.conf`, usado nos profiles multi instancia.

Os profiles estão padronizados da seguinte maneira:
- `single-unrestricted`: Subindo um unico container buildado do framework, e sem restrições de recursos de hardware.
- `single-restricted`: Da mesma forma que acima porém com restrições de recursos de hardware.
- `multi-unrestricted`: Subindo 2 containers (réplicas) do framework buildado + um nginx para o balanceamento de carga.
- `multi-restricted`: Da mesma forma que acima porém com restrições de recursos de hardware.

## Adicionando novos frameworks

1 arquivo apenas é necessário na adição de um novo framework:
- `compose.yaml`: Que conterá o docker compose com os profiles acima.

</br>
</br>

# Setup containers

## Example

### Setup

```bash
setup-benchmark.sh build
  --project <project-folder>
  --port <port>
  --profile <profile-name>
  --instance-cpu <value>
  --instance-ram <value>
  --nginx-cpu <value>
  --nginx-ram <value>
```

### Destroy

```bash
setup-benchmark.sh destroy
  --project <project-folder>
  --profile <profile-name>
```

</br>

## react-router-fastify

### Setup

```bash
# Single unrestricted
./setup-benchmark.sh build --project react-router-fastify --port 9999 --profile single-unrestricted

# Single restricted
./setup-benchmark.sh build --project react-router-fastify --port 9999 --profile single-restricted --instance-cpu '0.25' --instance-ram '0.3G' --nginx-cpu '0.05' --nginx-ram '0.2G'

# Multi unrestricted
./setup-benchmark.sh build --project react-router-fastify --port 9999 --profile multi-unrestricted

# Multi restricted
./setup-benchmark.sh build --project react-router-fastify --port 9999 --profile multi-restricted --instance-cpu '0.25' --instance-ram '0.3G' --nginx-cpu '0.05' --nginx-ram '0.2G'
```

### Destroy

```bash
# Single unrestricted
./setup-benchmark.sh destroy --project react-router-fastify --profile single-unrestricted

# Single restricted
./setup-benchmark.sh destroy --project react-router-fastify --profile single-restricted

# Multi unrestricted
./setup-benchmark.sh destroy --project react-router-fastify --profile multi-unrestricted

# Multi restricted
./setup-benchmark.sh destroy --project react-router-fastify --profile multi-restricted
```

</br>

## fastify

### Setup

```bash
# Single unrestricted
./setup-benchmark.sh build --project fastify --port 9999 --profile single-unrestricted

# Single restricted
./setup-benchmark.sh build --project fastify --port 9999 --profile single-restricted --instance-cpu '0.25' --instance-ram '0.3G' --nginx-cpu '0.05' --nginx-ram '0.2G'

# Multi unrestricted
./setup-benchmark.sh build --project fastify --port 9999 --profile multi-unrestricted

# Multi restricted
./setup-benchmark.sh build --project fastify --port 9999 --profile multi-restricted --instance-cpu '0.25' --instance-ram '0.3G' --nginx-cpu '0.05' --nginx-ram '0.2G'
```

### Destroy

```bash
# Single unrestricted
./setup-benchmark.sh destroy --project fastify --profile single-unrestricted

# Single restricted
./setup-benchmark.sh destroy --project fastify --profile single-restricted

# Multi unrestricted
./setup-benchmark.sh destroy --project fastify --profile multi-unrestricted

# Multi restricted
./setup-benchmark.sh destroy --project fastify --profile multi-restricted
```

</br>
</br>

# Running benchmark

Install autocannon if necessary:

```bash
npm install -g autocannon
```

## Example

```bash
./run-benchmark.sh --project <project-folder> --port <port>
```

</br>

## react-router-fastify

```bash
./run-benchmark.sh --project react-router-fastify --port 9999
```

</br>

## fastify

```bash
./run-benchmark.sh --project fastify --port 9999
```
